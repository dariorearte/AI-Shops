This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitattributes
.gitignore
eslint.config.js
index.html
package.json
public/vite.svg
README.md
src/App.css
src/App.jsx
src/assets/react.svg
src/BottomNav.jsx
src/index.css
src/main.jsx
src/supabaseClient.js
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitattributes">
# Auto detect text files and perform LF normalization
* text=auto
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="README.md">
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.
</file>

<file path="src/App.css">

</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/BottomNav.jsx">
import { Home, Search, ShoppingBag, User } from 'lucide-react';

const BottomNav = () => {
  return (
    <div className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-slate-100 px-6 py-3 flex justify-between items-center z-50 pb-6">
      <button className="flex flex-col items-center gap-1 text-blue-600">
        <Home size={24} />
        <span className="text-[10px] font-medium">Inicio</span>
      </button>
      <button className="flex flex-col items-center gap-1 text-slate-400 hover:text-blue-500">
        <Search size={24} />
        <span className="text-[10px] font-medium">Explorar</span>
      </button>
      <button className="flex flex-col items-center gap-1 text-slate-400 hover:text-blue-500">
        <ShoppingBag size={24} />
        <span className="text-[10px] font-medium">Tiendas</span>
      </button>
      <button className="flex flex-col items-center gap-1 text-slate-400 hover:text-blue-500">
        <User size={24} />
        <span className="text-[10px] font-medium">Perfil</span>
      </button>
    </div>
  );
};

export default BottomNav;
</file>

<file path="src/supabaseClient.js">
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = 'https://uhceapplbgalrdbwzhhc.supabase.co'
const supabaseAnonKey = 'sb_publishable_FZXwCCdhEetPa1ubmlnfaA_CpyNxl-O'

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
</file>

<file path="vite.config.js">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})
</file>

<file path="index.html">
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI-Shops</title>
    <!-- ESTO CARGA EL MAPA Y EL DISEÑO -->
    <link rel="stylesheet" href="https://unpkg.com" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Copia y pega esta línea exactamente así -->
    <link rel="stylesheet" href="https://unpkg.com" />
  </head>
  <body class="m-0 p-0 overflow-hidden">
    <div id="root" class="h-screen w-screen"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

html, body, #root {
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

/* Este es el truco para que el mapa no se corte */
.leaflet-container {
  width: 100% !important;
  height: 100% !important;
  z-index: 1;
}

/* Evita que el mapa se rompa en pantallas grandes */
.leaflet-map-pane {
  z-index: 1 !important;
}

/* Esto obliga al mapa a ocupar todo su espacio */
.leaflet-container {
  width: 100%;
  height: 100%;
  background-color: #242424; /* Color oscuro de fondo mientras carga */
}
</file>

<file path="src/main.jsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './index.css'
// 1. Importamos el proveedor
import { GoogleOAuthProvider } from '@react-oauth/google';

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    {/* 2. Envolvemos la App con tu ID real de Google */}
    <GoogleOAuthProvider clientId="702857412193-jgjetqbp14asaf4po3d01e7emgctl0ut.apps.googleusercontent.com">
      <App />
    </GoogleOAuthProvider>
  </React.StrictMode>,
)
</file>

<file path="package.json">
{
  "name": "ai-shops",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@react-navigation/material-top-tabs": "^7.4.13",
    "@react-oauth/google": "^0.13.4",
    "@supabase/supabase-js": "^2.97.0",
    "jwt-decode": "^4.0.0",
    "leaflet": "^1.9.4",
    "lucide-react": "^0.575.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-leaflet": "^5.0.0",
    "react-native-pager-view": "^8.0.0",
    "react-native-tab-view": "^4.2.2"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/react": "^19.2.7",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.24",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.2.0",
    "vite": "^7.3.1"
  }
}
</file>

<file path="src/App.jsx">
import React, { useState, useEffect, useCallback } from 'react';
import { MapContainer, TileLayer, Marker, useMap } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { 
  ShoppingBag, User, MapPin, Bike, Star, Clock, X, Plus, Minus, 
  Trash2, CreditCard, Banknote, Loader, CheckCircle2, ChevronRight,
  Utensils, Smartphone, Shirt, Pill, ShoppingCart, LogOut, Search, Moon, Sun, Sparkles, LayoutGrid, Camera
} from 'lucide-react';
import { GoogleLogin, googleLogout } from '@react-oauth/google';
import { jwtDecode } from "jwt-decode";
import { supabase } from './supabaseClient';

// --- CONFIGURACIÓN DE ICONOS LEAFLET (FIX) ---
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://unpkg.com',
  iconUrl: 'https://unpkg.com',
  shadowUrl: 'https://unpkg.com',
});

function RecenterMap({ position }) {
  const map = useMap();
  useEffect(() => { 
    if (position) { 
      map.setView(position, 15); 
      setTimeout(() => map.invalidateSize(), 500); 
    } 
  }, [position, map]);
  return null;
}

function App() {
  // --- 1. ESTADOS DE PERSISTENCIA Y NAVEGACIÓN ---
  const [usuario, setUsuario] = useState(() => JSON.parse(localStorage.getItem('ai_user')) || null);
  const [carrito, setCarrito] = useState(() => JSON.parse(localStorage.getItem('ai_cart')) || []);
  const [historialPedidos, setHistorialPedidos] = useState(() => JSON.parse(localStorage.getItem('ai_history')) || []);
  const [darkMode, setDarkMode] = useState(() => JSON.parse(localStorage.getItem('ai_dark')) ?? true);
  const [caraVisible, setCaraVisible] = useState("mapa"); 
  
  // --- 2. ESTADOS DE FLUJO ---
  const [busqueda, setBusqueda] = useState("");
  const [position, setPosition] = useState(null);
  const [tiendas, setTiendas] = useState([]);
  const [tiendaSeleccionada, setTiendaSeleccionada] = useState(null);
  const [verMenu, setVerMenu] = useState(false);
  const [verMenuUsuario, setVerMenuUsuario] = useState(false);
  const [enCheckout, setEnCheckout] = useState(false);
  const [rastreando, setRastreando] = useState(false);
  const [motoPos, setMotoPos] = useState(null);
  const [pedidoEntregado, setPedidoEntregado] = useState(false);
  const [metodoPago, setMetodoPago] = useState('efectivo');

  // --- 3. ESTADOS DE IA ---
  const [sugerenciaIA, setSugerenciaIA] = useState(null);
  const [pensandoIA, setPensandoIA] = useState(false);
  const [mostrarCupon, setMostrarCupon] = useState(false);
  const [itemSugeridoIA, setItemSugeridoIA] = useState(null);

  useEffect(() => {
    localStorage.setItem('ai_user', JSON.stringify(usuario));
    localStorage.setItem('ai_cart', JSON.stringify(carrito));
    localStorage.setItem('ai_history', JSON.stringify(historialPedidos));
    localStorage.setItem('ai_dark', JSON.stringify(darkMode));
    if (darkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  }, [usuario, carrito, historialPedidos, darkMode]);
  // --- 4. GEOLOCALIZACIÓN Y TIENDAS ---
  useEffect(() => {
    navigator.geolocation.getCurrentPosition((pos) => {
      const { latitude: lat, longitude: lng } = pos.coords;
      setPosition([lat, lng]);
      setTiendas([
        { 
          id: 1, nombre: "Café AI", cat: "gastronomia", lat: lat + 0.003, lng: lng + 0.003, color: '#EF4444', 
          productos: [
            {id: 101, n: "Espresso Italiano", p: 1200, img: "https://images.unsplash.com"}, 
            {id: 102, n: "Muffin Arándanos", p: 800, img: "https://images.unsplash.com"}
          ] 
        },
        { id: 2, nombre: "Tech Store", cat: "tecnologia", lat: lat - 0.003, lng: lng - 0.003, color: '#3B82F6', 
          productos: [
            {id: 201, n: "Cargador Pro", p: 4500, img: "https://images.unsplash.com"},
            {id: 202, n: "Audífonos In-Ear", p: 8500, img: "https://images.unsplash.com"}
          ] 
        },
      ]);
    });
  }, []);

  // --- 5. FUNCIONES LÓGICAS (RECONSTRUIDAS) ---
  const handleLoginSuccess = (res) => {
    const d = jwtDecode(res.credential);
    const datosUser = { nombre: d.given_name, foto: d.picture, email: d.email };
    setUsuario(datosUser);
    setVerMenuUsuario(false);
  };

  const agregarAlCarrito = (p, esIA = false) => {
    setCarrito(prev => {
      const existe = prev.find(i => i.id === p.id);
      if (existe) return prev.map(i => i.id === p.id ? {...i, cant: i.cant + 1} : i);
      return [...prev, {...p, cant: 1, tId: tiendaSeleccionada?.id || 1}];
    });
    if (esIA) { setMostrarCupon(true); setSugerenciaIA(null); setItemSugeridoIA(null); }
  };

  const quitarDelCarrito = (id) => {
    setCarrito(prev => {
      const item = prev.find(i => i.id === id);
      if (item?.cant > 1) return prev.map(i => i.id === id ? {...i, cant: i.cant - 1} : i);
      return prev.filter(i => i.id !== id);
    });
  };

  const consultarIA = () => {
    setPensandoIA(true);
    setTimeout(() => {
      const items = carrito.map(i => i.n.toLowerCase());
      if (items.some(n => n.includes("espresso")) && !items.some(n => n.includes("muffin"))) {
        setSugerenciaIA("Tu Espresso se siente solo. ¿Sumamos un Muffin?");
        setItemSugeridoIA({id: 102, n: "Muffin Arándanos", p: 800, img: "https://images.unsplash.com"});
      } else { setSugerenciaIA("¡Tu selección es perfecta!"); setItemSugeridoIA(null); }
      setPensandoIA(false);
    }, 1200);
  };

  const confirmarPedido = () => {
    setEnCheckout(true);
    setTimeout(() => {
      setEnCheckout(false); setCaraVisible("mapa"); setRastreando(true);
      const tId = carrito[0]?.tId || 1;
      const tOrigen = tiendas.find(t => t.id === tId) || tiendas[0];
      setMotoPos([tOrigen.lat, tOrigen.lng]);
      let t = 0;
      const interval = setInterval(() => {
        t += 0.05;
        if (t >= 1) { clearInterval(interval); setMotoPos(position); setPedidoEntregado(true); }
        else setMotoPos([tOrigen.lat + (position[0] - tOrigen.lat) * t, tOrigen.lng + (position[1] - tOrigen.lng) * t]);
      }, 1000);
    }, 1500);
  };

  const finalizarPedidoYLimpiar = async () => {
    const total = carrito.reduce((acc, i) => acc + (i.p * i.cant), 0);
    const pedido = { usuario_email: usuario?.email || 'anon@ai.com', total, items: carrito, fecha: new Date().toISOString() };
    try { await supabase.from('pedidos').insert([pedido]); } catch (err) { console.error(err); }
    setHistorialPedidos(prev => [pedido, ...prev]);
    setRastreando(false); setPedidoEntregado(false); setCarrito([]); setCaraVisible("pedidos");
  };
  // --- 6. RENDERIZADO DE INTERFAZ ---
  return (
    <div className="flex flex-col h-screen w-full bg-slate-50 dark:bg-slate-950 overflow-hidden font-sans selection:bg-blue-500/30">
      
      {/* HEADER ULTRA-PREMIUM GLASS */}
      <header className="fixed top-0 left-0 right-0 z-[100] px-6 py-4 flex justify-between items-center bg-white/60 dark:bg-slate-950/60 backdrop-blur-2xl border-b border-white/20 dark:border-white/5">
        <div className="flex items-center gap-3 cursor-pointer group" onClick={() => {setCaraVisible("mapa"); setVerMenu(false);}}>
          <div className="w-12 h-12 bg-slate-900 dark:bg-white rounded-[22px] flex items-center justify-center font-black text-white dark:text-slate-900 shadow-2xl transition-transform active:scale-90">AI</div>
          <div className="flex flex-col leading-none text-left">
            <h1 className="text-2xl font-black italic dark:text-white tracking-tighter uppercase">Shops</h1>
            <span className="text-[9px] font-black text-blue-600 tracking-[0.2em] uppercase">Intelligence</span>
          </div>
        </div>
        <button onClick={() => setVerMenuUsuario(!verMenuUsuario)} className="w-12 h-12 bg-white/80 dark:bg-slate-800 rounded-[22px] overflow-hidden border-2 border-white dark:border-slate-700 shadow-xl active:scale-90 transition-all">
          {usuario ? <img src={usuario.foto} className="w-full h-full object-cover"/> : <User className="mx-auto mt-3 dark:text-white"/>}
        </button>
      </header>

      <main className="flex-1 relative mt-[80px] overflow-hidden">
        
        {/* --- CARA 1: E-COMMERCE (DISEÑO INDUCTIVO) --- */}
        <div className={`absolute inset-0 z-30 bg-slate-50 dark:bg-slate-950 transition-all duration-700 ease-[cubic-bezier(0.23,1,0.32,1)] transform ${caraVisible === 'ecommerce' ? 'translate-x-0 opacity-100' : '-translate-x-full opacity-0 pointer-events-none'}`}>
          <div className="p-8 h-full overflow-y-auto pb-40">
             <div className="flex justify-between items-center mb-10">
                <h2 className="text-5xl font-black italic dark:text-white tracking-tighter uppercase text-left leading-[0.85]">AI<br/><span className="text-blue-600">DEALS</span></h2>
                <div className="p-4 bg-white dark:bg-slate-900 rounded-[25px] shadow-xl border dark:border-slate-800"><Search size={24} className="text-slate-400"/></div>
             </div>
             <div className="grid grid-cols-1 gap-10">
               {tiendas.flatMap(t => t.productos).map(p => (
                 <div key={p.id} className="bg-white dark:bg-slate-900 rounded-[50px] overflow-hidden shadow-2xl border dark:border-slate-800 group active:scale-95 transition-all">
                    <img src={p.img} className="w-full h-80 object-cover" alt={p.n} />
                    <div className="p-10 text-left">
                       <h3 className="font-black text-3xl dark:text-white italic uppercase mb-4">{p.n}</h3>
                       <div className="flex justify-between items-center">
                          <span className="font-black text-4xl dark:text-white tracking-tighter">$ {p.p}</span>
                          <button onClick={() => {setTiendaSeleccionada(tiendas[0]); setVerMenu(true);}} className="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-10 py-5 rounded-3xl font-black uppercase text-[12px] tracking-widest shadow-2xl">Añadir</button>
                       </div>
                    </div>
                 </div>
               ))}
             </div>
          </div>
        </div>

        {/* --- CARA 2: MAPA (CENTRAL) --- */}
        <div className={`absolute inset-0 z-10 transition-all duration-1000 ${caraVisible === 'mapa' ? 'scale-100 opacity-100' : 'scale-125 blur-3xl opacity-20 pointer-events-none'}`}>
          {position && (
            <MapContainer center={position} zoom={15} style={{ height: '100%', width: '100%' }} zoomControl={false}>
              <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />
              <RecenterMap position={position} />
              <Marker position={position} icon={L.divIcon({ html: `<div class="w-6 h-6 bg-blue-600 rounded-full border-4 border-white shadow-2xl animate-pulse"></div>` })} />
              {tiendas.map(t => (
                <Marker key={t.id} position={[t.lat, t.lng]} eventHandlers={{ click: () => setTiendaSeleccionada(t) }}
                  icon={L.divIcon({ html: `<div class="w-14 h-14 rounded-[25px] border-4 border-white shadow-2xl flex items-center justify-center text-white" style="background-color: ${t.color}"><MapPin size={24}/></div>` })}
                />
              ))}
              {rastreando && motoPos && <Marker position={motoPos} icon={L.divIcon({ html: `<div class="bg-blue-600 p-3 rounded-full border-4 border-white shadow-2xl text-white animate-bounce"><Bike size={28}/></div>` })} />}
            </MapContainer>
          )}
        </div>
        {/* --- CARA 3: MARKETPLACE (COMUNIDAD) --- */}
        <div className={`absolute inset-0 z-30 bg-slate-50 dark:bg-slate-950 transition-all duration-700 ease-out transform ${caraVisible === 'social' ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0 pointer-events-none'}`}>
           <div className="p-8 h-full overflow-y-auto pb-40">
              <div className="flex justify-between items-center mb-10">
                 <h2 className="text-5xl font-black italic dark:text-white tracking-tighter uppercase text-left leading-[0.85]">COMMU<br/><span className="text-blue-600">NITY</span></h2>
                 <button className="bg-blue-600 text-white p-5 rounded-[28px] shadow-2xl active:scale-90 transition-all"><Camera size={28}/></button>
              </div>
              <div className="grid grid-cols-2 gap-5">
                {[1,2,3,4].map(i => (
                  <div key={i} className="bg-white dark:bg-slate-900 rounded-[35px] overflow-hidden border dark:border-slate-800 shadow-xl group active:scale-95 transition-all">
                    <div className="h-48 bg-slate-100 dark:bg-slate-800 relative flex items-center justify-center opacity-30">
                       <ShoppingCart size={40}/>
                    </div>
                    <div className="p-6 text-left">
                       <p className="font-black text-2xl dark:text-white leading-none mb-1">$ {i * 2500}</p>
                       <p className="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Articulo • {i}km cerca</p>
                    </div>
                  </div>
                ))}
              </div>
           </div>
        </div>

        {/* MODAL MENU TIENDA */}
        {verMenu && tiendaSeleccionada && (
          <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-xl flex items-end">
            <div className="bg-white dark:bg-slate-900 w-full rounded-t-[60px] p-10 max-h-[85vh] overflow-y-auto animate-in slide-in-from-bottom-full border-t dark:border-white/10 shadow-2xl">
              <div className="flex justify-between items-center mb-10"><h2 className="text-3xl font-black dark:text-white italic uppercase tracking-tighter leading-none">Menú</h2><button onClick={() => setVerMenu(false)} className="p-4 bg-slate-100 dark:bg-slate-800 rounded-full dark:text-white"><X size={24}/></button></div>
              <div className="space-y-6 mb-12">{(tiendaSeleccionada.productos || tiendas[0].productos).map(p => {
                const cant = carrito.find(i => i.id === p.id)?.cant || 0;
                return (
                  <div key={p.id} className="flex items-center gap-6 p-5 bg-slate-50 dark:bg-slate-800/50 rounded-[35px] border dark:border-slate-800 shadow-sm">
                    <img src={p.img} className="w-24 h-24 rounded-[25px] object-cover shadow-xl" />
                    <div className="flex-1 text-left"><p className="font-black dark:text-white text-lg uppercase italic leading-none mb-2">{p.n}</p><p className="font-black text-xl text-blue-600 dark:text-blue-400">$ {p.p}</p></div>
                    <div className="flex items-center gap-4 bg-white dark:bg-slate-900 p-2 rounded-2xl border dark:border-slate-700 shadow-xl">
                      <button onClick={() => quitarDelCarrito(p.id)} className="p-2 text-red-500"><Minus size={20}/></button>
                      <span className="font-black text-xl dark:text-white w-6 text-center">{cant}</span>
                      <button onClick={() => agregarAlCarrito(p)} className="p-2 text-green-600"><Plus size={20}/></button>
                    </div>
                  </div>
                )})}</div>
              <button onClick={() => {setVerMenu(false); setCaraVisible("carrito");}} className="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-black py-6 rounded-[30px] uppercase tracking-[0.2em] text-xs shadow-2xl">Revisar Bolsa ({carrito.length})</button>
            </div>
          </div>
        )}

        {/* CARRITO / BOLSA */}
        {caraVisible === "carrito" && (
          <div className="absolute inset-0 z-50 bg-white dark:bg-slate-950 p-8 overflow-y-auto animate-in slide-in-from-right-20">
            <div className="flex justify-between items-center mb-10"><h2 className="text-3xl font-black dark:text-white italic uppercase tracking-tighter">Bolsa</h2><button onClick={() => setCaraVisible("mapa")} className="p-4 bg-slate-100 dark:bg-slate-800 rounded-2xl dark:text-white"><X size={20}/></button></div>
            {carrito.length === 0 ? <p className="text-center opacity-10 py-32 font-black text-4xl uppercase italic">Vacia</p> : (
              <div className="flex flex-col gap-8">
                <div className="p-8 bg-gradient-to-br from-blue-600 to-purple-700 rounded-[40px] text-white shadow-2xl relative overflow-hidden group">
                  <div className="flex justify-between items-center mb-6"><div className="flex items-center gap-2 font-black uppercase text-[10px] tracking-widest"><Star size={16}/> AI Engine</div><button onClick={consultarIA} disabled={pensandoIA} className="bg-white/20 px-4 py-1.5 rounded-full text-[10px] font-black backdrop-blur-md uppercase">{pensandoIA ? "Procesando..." : "Optimizar"}</button></div>
                  {sugerenciaIA && (
                    <div className="animate-in fade-in slide-in-from-top-2">
                      <p className="text-lg font-black italic mb-6 leading-tight">"{sugerenciaIA}"</p>
                      {itemSugeridoIA && <button onClick={() => agregarAlCarrito(itemSugeridoIA, true)} className="w-full bg-white text-slate-900 font-black py-4 rounded-2xl text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 active:scale-95 transition-all">Sumar {itemSugeridoIA.n}</button>}
                    </div>
                  )}
                </div>
                {carrito.map(i => (
                  <div key={i.id} className="flex justify-between items-center p-5 bg-slate-50 dark:bg-slate-900 rounded-[32px] border dark:border-slate-800"><div className="flex items-center gap-4 text-left"><img src={i.img} className="w-16 h-16 rounded-[20px] object-cover" /><p className="font-black dark:text-white text-sm uppercase italic">{i.cant}x {i.n}</p></div><p className="font-black dark:text-white text-lg tracking-tighter">$ {i.p * i.cant}</p></div>
                ))}
                <button onClick={confirmarPedido} className="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-black py-6 rounded-[30px] shadow-2xl text-lg flex items-center justify-center gap-3 uppercase tracking-widest">
                  {enCheckout ? <Loader className="animate-spin" size={24}/> : "Confirmar Compra"}
                </button>
              </div>
            )}
          </div>
        )}
      </main>

      {/* NAV INFERIOR PREMIUM */}
      <nav className="fixed bottom-8 left-8 right-8 z-50 h-24 bg-white/70 dark:bg-slate-900/70 backdrop-blur-3xl rounded-[40px] border border-white/20 dark:border-white/5 shadow-[0_25px_50px_-12px_rgba(0,0,0,0.5)] flex justify-around items-center px-6">
        <button onClick={() => setCaraVisible("ecommerce")} className={`p-5 rounded-[28px] transition-all duration-500 ${caraVisible === 'ecommerce' ? "bg-blue-600 text-white shadow-2xl scale-110" : "text-slate-400 opacity-50"}`}>
          <LayoutGrid size={28} strokeWidth={2.5}/>
        </button>
        <button onClick={() => setCaraVisible("mapa")} className={`p-6 rounded-[30px] transition-all duration-500 transform ${caraVisible === 'mapa' ? "bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-2xl scale-125 -translate-y-4" : "text-slate-400 opacity-50"}`}>
          <MapPin size={32} strokeWidth={2.5}/>
        </button>
        <button onClick={() => setCaraVisible("social")} className={`p-5 rounded-[28px] transition-all duration-500 ${caraVisible === 'social' ? "bg-blue-600 text-white shadow-2xl scale-110" : "text-slate-400 opacity-50"}`}>
          <ShoppingCart size={28} strokeWidth={2.5}/>
        </button>
      </nav>

      {/* POP-UP CUPÓN IA */}
      {mostrarCupon && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center p-8 bg-black/80 backdrop-blur-xl animate-in fade-in">
          <div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[50px] p-10 shadow-2xl border-4 border-blue-600 relative overflow-hidden">
            <div className="flex flex-col items-center text-center">
              <div className="w-24 h-24 bg-blue-600 rounded-[30px] flex items-center justify-center mb-8 shadow-2xl rotate-12 animate-bounce"><Sparkles size={48} className="text-white"/></div>
              <h3 className="text-4xl font-black dark:text-white italic tracking-tighter mb-8 uppercase leading-none">IA Match!</h3>
              <div className="w-full py-5 bg-slate-100 dark:bg-slate-800 rounded-3xl border-2 border-dashed border-blue-500 mb-8"><span className="text-3xl font-black text-blue-600 uppercase tracking-widest">AISHOP15</span></div>
              <button onClick={() => setMostrarCupon(false)} className="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-black py-5 rounded-2xl uppercase text-[10px]">Cerrar</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default App;
</file>

</files>
